name: dbt CI

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: jaffle_db
          POSTGRES_USER: jaffle_user
          POSTGRES_PASSWORD: jaffle_pass
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U jaffle_user -d jaffle_db"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Wait for Postgres to be ready
        env:
          PGPASSWORD: jaffle_pass
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client
          echo "Waiting for postgres..."
          for i in {1..30}; do
            pg_isready -h localhost -p 5432 -U jaffle_user -d jaffle_db && break
            echo "Postgres not ready yet ($i/30) â€” sleeping 2s"
            sleep 2
          done

      - name: Create dbt profile
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml <<'YML'
          jaffle_shop:
            target: dev
            outputs:
              dev:
                type: postgres
                host: localhost
                user: jaffle_user
                password: jaffle_pass
                dbname: jaffle_db
                schema: public
                port: 5432
          YML

      - name: Install dbt dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dbt-postgres

      - name: Run dbt seed and build
        run: |
          dbt debug
          dbt seed
          dbt run --select stg_customers stg_orders stg_payments
          dbt test
